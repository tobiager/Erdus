# Database Migration Guide

This guide explains how to use Erdus to migrate database schemas from various engines to PostgreSQL/Supabase.

## Overview

The `erdus migrar-db` command converts DDL scripts from 6 different database engines to PostgreSQL-compatible SQL suitable for Supabase deployment.

## Supported Source Engines

### 1. Microsoft SQL Server

**Status:** âœ… Full Support  
**File Extensions:** `.sql`, `.ddl`

**Example Usage:**
```bash
erdus migrar-db --engine sqlserver --in ./schemas/sqlserver.sql --out ./output/supabase.sql
```

**Supported Features:**
- Tables with all column types
- Primary and foreign key constraints
- Unique constraints and indexes
- CHECK constraints
- Default values (with function mapping)
- Comments on tables and columns

**Type Mappings:**
```sql
-- SQL Server â†’ PostgreSQL
INT              â†’ integer
BIGINT           â†’ bigint
BIT              â†’ boolean
DECIMAL(p,s)     â†’ numeric(p,s)
VARCHAR(n)       â†’ varchar(n)
NVARCHAR(n)      â†’ varchar(n)
TEXT/NTEXT       â†’ text
DATETIME2        â†’ timestamp with time zone
UNIQUEIDENTIFIER â†’ uuid
VARBINARY        â†’ bytea
```

**Function Mappings:**
```sql
GETDATE()    â†’ now()
NEWID()      â†’ gen_random_uuid()
CURRENT_USER â†’ CURRENT_USER
```

### 2. MySQL

**Status:** ðŸš§ Planned  
**Features:** Basic table structure, common data types

### 3. Oracle Database  

**Status:** ðŸš§ Planned  
**Features:** Standard Oracle types, PL/SQL procedures (basic)

### 4. PostgreSQL

**Status:** ðŸš§ Planned  
**Purpose:** Schema normalization and Supabase optimization

### 5. SQLite

**Status:** ðŸš§ Planned  
**Features:** Type affinity mapping, constraint conversion

### 6. MongoDB

**Status:** ðŸš§ Planned  
**Purpose:** Convert collections and indexes to relational schema

## Migration Examples

### SQL Server to Supabase

**Input (SQL Server):**
```sql
-- Create Users table
CREATE TABLE Users (
    Id INT IDENTITY(1,1) PRIMARY KEY,
    Email NVARCHAR(255) NOT NULL UNIQUE,
    FirstName NVARCHAR(100) NULL,
    LastName NVARCHAR(100) NULL,
    CreatedAt DATETIME2 DEFAULT GETDATE(),
    IsActive BIT DEFAULT 1,
    ProfileData NVARCHAR(MAX) NULL
);

-- Create Orders table  
CREATE TABLE Orders (
    Id INT IDENTITY(1,1) PRIMARY KEY,
    UserId INT NOT NULL,
    OrderNumber NVARCHAR(50) NOT NULL UNIQUE,
    Total DECIMAL(10,2) NOT NULL,
    Status NVARCHAR(20) DEFAULT 'pending',
    CreatedAt DATETIME2 DEFAULT GETDATE(),
    CONSTRAINT FK_Orders_Users FOREIGN KEY (UserId) REFERENCES Users(Id) ON DELETE CASCADE,
    CONSTRAINT CHK_Orders_Total CHECK (Total >= 0)
);

-- Create index
CREATE INDEX IX_Orders_Status ON Orders(Status, CreatedAt);
```

**Command:**
```bash
erdus migrar-db \
  --engine sqlserver \
  --in ./sql-server-schema.sql \
  --schema public \
  --with-rls \
  --out ./supabase-schema.sql
```

**Output (PostgreSQL/Supabase):**
```sql
-- Database Migration Script
-- Generated by Erdus Migration Tool
-- Target: PostgreSQL/Supabase (schema: public)

-- Enable required extensions
CREATE EXTENSION IF NOT EXISTS 'uuid-ossp';
CREATE EXTENSION IF NOT EXISTS 'pgcrypto';

-- Tables
CREATE TABLE users (
  id serial PRIMARY KEY,
  email varchar(255) NOT NULL UNIQUE,
  first_name varchar(100),
  last_name varchar(100),
  created_at timestamp with time zone DEFAULT now(),
  is_active boolean DEFAULT true,
  profile_data text
);

CREATE TABLE orders (
  id serial PRIMARY KEY,
  user_id integer NOT NULL,
  order_number varchar(50) NOT NULL UNIQUE,
  total numeric(10,2) NOT NULL,
  status varchar(20) DEFAULT 'pending',
  created_at timestamp with time zone DEFAULT now()
);

-- Foreign key constraints
ALTER TABLE orders ADD CONSTRAINT fk_orders_user_id 
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE;

-- Check constraints
ALTER TABLE orders ADD CONSTRAINT chk_orders_total CHECK (total >= 0);

-- Indexes
CREATE INDEX ix_orders_status ON orders (status, created_at);

-- Row Level Security Policies
ALTER TABLE users ENABLE ROW LEVEL SECURITY;
CREATE POLICY "authenticated_full_access_users" ON users
  FOR ALL USING (auth.role() = 'authenticated');

ALTER TABLE orders ENABLE ROW LEVEL SECURITY;
CREATE POLICY "authenticated_full_access_orders" ON orders
  FOR ALL USING (auth.role() = 'authenticated');
```

## Advanced Options

### Row Level Security (RLS)

Enable RLS with `--with-rls` flag:

```bash
erdus migrar-db --engine sqlserver --in schema.sql --with-rls --out schema.sql
```

**Owner-based Policies:**
If your tables have an `owner_id` column, Erdus generates owner-based policies:

```sql
-- For tables with owner_id column
CREATE POLICY "owner_can_select_posts" ON posts
  FOR SELECT USING (auth.uid() = owner_id);

CREATE POLICY "owner_can_update_posts" ON posts  
  FOR UPDATE USING (auth.uid() = owner_id);

CREATE POLICY "owner_can_delete_posts" ON posts
  FOR DELETE USING (auth.uid() = owner_id);

CREATE POLICY "authenticated_can_insert_posts" ON posts
  FOR INSERT WITH CHECK (auth.role() = 'authenticated');
```

**General Policies:**
For tables without `owner_id`:

```sql
CREATE POLICY "authenticated_full_access_users" ON users
  FOR ALL USING (auth.role() = 'authenticated');
```

### Schema Targeting

Specify target schema with `--schema`:

```bash
erdus migrar-db --engine sqlserver --in schema.sql --schema staging --out schema.sql
```

This prefixes all table names: `staging.users`, `staging.orders`, etc.

### Custom Mappings

**Default Value Mapping:**
Erdus automatically maps database-specific functions:

| Source Engine | Original | PostgreSQL |
|---------------|----------|------------|
| SQL Server | `GETDATE()` | `now()` |
| SQL Server | `NEWID()` | `gen_random_uuid()` |
| MySQL | `NOW()` | `now()` |
| MySQL | `UUID()` | `gen_random_uuid()` |
| Oracle | `SYSDATE` | `now()` |

**Type Precision:**
Numeric types preserve precision and scale:
- `DECIMAL(10,2)` â†’ `numeric(10,2)`
- `VARCHAR(255)` â†’ `varchar(255)`

## Troubleshooting

### Common Issues

**1. Unsupported SQL Syntax**
```
Error: Failed to parse statement: CREATE TRIGGER...
```
*Solution:* Erdus focuses on DDL. Remove triggers, stored procedures, and functions from the input file.

**2. Reserved Word Conflicts**
```
Error: 'user' is a reserved word
```
*Solution:* Use quoted identifiers or rename conflicting columns.

**3. Complex CHECK Constraints**
```
Warning: Complex CHECK constraint may need manual review
```
*Solution:* Verify generated CHECK expressions work in PostgreSQL.

### Manual Review Checklist

After migration, manually review:

- [ ] **Data Types**: Verify numeric precision is preserved
- [ ] **Constraints**: Test CHECK constraints with sample data  
- [ ] **Indexes**: Confirm index performance on PostgreSQL
- [ ] **Defaults**: Test default value expressions
- [ ] **RLS Policies**: Verify security policies match requirements

### Testing Migrations

**1. Syntax Validation:**
```bash
# Test generated SQL syntax
psql --dry-run -f supabase-schema.sql
```

**2. Schema Comparison:**
```bash
# Compare before/after with sqldiff or similar tools
sqldiff original.sql migrated.sql
```

**3. Integration Testing:**
```bash
# Test with sample data
psql -f supabase-schema.sql
psql -c "INSERT INTO users (email, first_name) VALUES ('test@example.com', 'Test');"
```

## Best Practices

### Pre-Migration

1. **Clean Input Files**: Remove non-DDL statements (triggers, procedures, data)
2. **Document Dependencies**: Note any application-specific logic in triggers
3. **Backup Original**: Keep original DDL files for reference

### Post-Migration

1. **Review Generated SQL**: Always review before applying to production
2. **Test RLS Policies**: Verify security policies work as expected
3. **Performance Testing**: Benchmark indexes and queries
4. **Update Application**: Modify connection strings and queries as needed

### Schema Evolution

1. **Version Control**: Store IR files alongside application code
2. **Migration Scripts**: Use `erdus diff` for incremental changes
3. **CI/CD Integration**: Automate migration in deployment pipelines

## Integration Examples

### GitHub Actions

```yaml
name: Database Migration
on:
  push:
    paths: ['schema/**']

jobs:
  migrate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Install Erdus
        run: npm install -g erdplus-converter
        
      - name: Generate Supabase Schema  
        run: |
          erdus migrar-db \
            --engine sqlserver \
            --in ./schema/sqlserver.sql \
            --with-rls \
            --out ./supabase-schema.sql
            
      - name: Deploy to Supabase
        env:
          SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
        run: |
          psql $SUPABASE_DB_URL -f supabase-schema.sql
```

### Docker Workflow

```dockerfile
FROM node:18
RUN npm install -g erdplus-converter

COPY schema.sql /input/
RUN erdus migrar-db --engine sqlserver --in /input/schema.sql --out /output/supabase.sql

# Deploy with psql or Supabase CLI
```

---

The migration tool is designed to handle 80% of common migration scenarios automatically, with clear guidance for the remaining 20% that require manual attention.