# Database Migration Guide

This guide explains how to use the `migrar-db` command to migrate SQL scripts from various database engines to Supabase/PostgreSQL.

## Overview

The `migrar-db` command provides automated migration of DDL (Data Definition Language) scripts between different database platforms. It currently supports 6 source engines with PostgreSQL/Supabase as the target.

## Basic Usage

```bash
erdus migrar-db --engine <source> --in <input.sql> --out <output.sql>
```

## Source Engines

### SQL Server → PostgreSQL

**Command:**
```bash
erdus migrar-db --engine sqlserver --in ./sqlserver-schema.sql --out ./postgres-schema.sql
```

**Example Input (SQL Server):**
```sql
CREATE TABLE [Users] (
    [Id] UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
    [Email] NVARCHAR(255) NOT NULL UNIQUE,
    [Name] NVARCHAR(100) NULL,
    [Age] INT NULL,
    [CreatedAt] DATETIME2 DEFAULT GETDATE(),
    [IsActive] BIT DEFAULT 1
);

CREATE TABLE [Posts] (
    [Id] UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
    [UserId] UNIQUEIDENTIFIER NOT NULL,
    [Title] NVARCHAR(200) NOT NULL,
    [Content] NTEXT NULL,
    [PublishedAt] DATETIME2 NULL,
    CONSTRAINT [FK_Posts_Users] FOREIGN KEY ([UserId]) REFERENCES [Users]([Id])
);
```

**Generated Output (PostgreSQL):**
```sql
-- Generated Supabase schema
-- Generated on: 2024-01-15T10:30:00.000Z

-- Tables
CREATE TABLE "Users" (
  "Id" uuid NOT NULL DEFAULT gen_random_uuid(),
  "Email" varchar(255) NOT NULL UNIQUE,
  "Name" varchar(100),
  "Age" integer,
  "CreatedAt" timestamp with time zone NOT NULL DEFAULT now(),
  "IsActive" boolean DEFAULT true,
  CONSTRAINT "Users_pkey" PRIMARY KEY ("Id")
);

CREATE TABLE "Posts" (
  "Id" uuid NOT NULL DEFAULT gen_random_uuid(),
  "UserId" uuid NOT NULL,
  "Title" varchar(200) NOT NULL,
  "Content" text,
  "PublishedAt" timestamp with time zone,
  CONSTRAINT "Posts_pkey" PRIMARY KEY ("Id")
);

-- Foreign Key Constraints
ALTER TABLE "Posts" ADD CONSTRAINT "fk_Posts_UserId" FOREIGN KEY ("UserId") REFERENCES "Users" ("Id");
```

### MySQL → PostgreSQL

**Command:**
```bash
erdus migrar-db --engine mysql --in ./mysql-schema.sql --out ./postgres-schema.sql
```

**Example Input (MySQL):**
```sql
CREATE TABLE Users (
    id INT AUTO_INCREMENT PRIMARY KEY,
    email VARCHAR(255) NOT NULL UNIQUE,
    name VARCHAR(100),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    is_active TINYINT(1) DEFAULT 1
);

CREATE TABLE Posts (
    id INT AUTO_INCREMENT PRIMARY KEY,
    user_id INT NOT NULL,
    title VARCHAR(200) NOT NULL,
    content TEXT,
    tags JSON,
    FOREIGN KEY (user_id) REFERENCES Users(id) ON DELETE CASCADE
);
```

**Generated Output (PostgreSQL):**
```sql
CREATE TABLE "Users" (
  "id" serial NOT NULL,
  "email" varchar(255) NOT NULL UNIQUE,
  "name" varchar(100),
  "created_at" timestamp NOT NULL DEFAULT now(),
  "is_active" boolean DEFAULT true,
  CONSTRAINT "Users_pkey" PRIMARY KEY ("id")
);

CREATE TABLE "Posts" (
  "id" serial NOT NULL,
  "user_id" integer NOT NULL,
  "title" varchar(200) NOT NULL,
  "content" text,
  "tags" jsonb,
  CONSTRAINT "Posts_pkey" PRIMARY KEY ("id")
);

-- Foreign Key Constraints
ALTER TABLE "Posts" ADD CONSTRAINT "fk_Posts_user_id" FOREIGN KEY ("user_id") REFERENCES "Users" ("id") ON DELETE CASCADE;
```

### Oracle → PostgreSQL

**Example Input (Oracle):**
```sql
CREATE TABLE Users (
    Id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    Email VARCHAR2(255) NOT NULL UNIQUE,
    Name VARCHAR2(100),
    CreatedAt TIMESTAMP DEFAULT SYSDATE,
    UserId RAW(16) DEFAULT SYS_GUID()
);
```

**Generated Output:**
```sql
CREATE TABLE "Users" (
  "Id" serial NOT NULL,
  "Email" varchar(255) NOT NULL UNIQUE,
  "Name" varchar(100),
  "CreatedAt" timestamp NOT NULL DEFAULT now(),
  "UserId" uuid DEFAULT gen_random_uuid(),
  CONSTRAINT "Users_pkey" PRIMARY KEY ("Id")
);
```

### SQLite → PostgreSQL

**Example Input (SQLite):**
```sql
CREATE TABLE Users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    email TEXT NOT NULL UNIQUE,
    name TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

**Generated Output:**
```sql
CREATE TABLE "Users" (
  "id" serial NOT NULL,
  "email" text NOT NULL UNIQUE,
  "name" text,
  "created_at" timestamp NOT NULL DEFAULT now(),
  CONSTRAINT "Users_pkey" PRIMARY KEY ("id")
);
```

### MongoDB → PostgreSQL

**Example Input (MongoDB Schema):**
```json
{
  "collections": [
    {
      "name": "users",
      "schema": {
        "_id": { "bsonType": "objectId" },
        "email": { "bsonType": "string", "required": true },
        "name": { "bsonType": "string" },
        "profile": { "bsonType": "object" },
        "tags": { "bsonType": "array" },
        "createdAt": { "bsonType": "date" }
      }
    }
  ]
}
```

**Generated Output:**
```sql
CREATE TABLE "users" (
  "_id" uuid NOT NULL,
  "email" text NOT NULL,
  "name" text,
  "profile" jsonb,
  "tags" jsonb,
  "createdAt" timestamp with time zone,
  CONSTRAINT "users_pkey" PRIMARY KEY ("_id")
);
```

## Row Level Security (RLS)

Add the `--with-rls` flag to generate Row Level Security policies:

```bash
erdus migrar-db --engine sqlserver --in ./input.sql --with-rls --out ./output.sql
```

**Generated RLS Policies:**

For tables with `owner_id` or `user_id` columns:
```sql
-- Enable RLS
ALTER TABLE "Posts" ENABLE ROW LEVEL SECURITY;

-- Owner can select their own records
CREATE POLICY "Posts_owner_select" ON "Posts" 
FOR SELECT USING (auth.uid()::text = "user_id"::text);

-- Owner can update their own records  
CREATE POLICY "Posts_owner_update" ON "Posts"
FOR UPDATE USING (auth.uid()::text = "user_id"::text);

-- Owner can delete their own records
CREATE POLICY "Posts_owner_delete" ON "Posts"
FOR DELETE USING (auth.uid()::text = "user_id"::text);

-- Authenticated users can insert
CREATE POLICY "Posts_authenticated_insert" ON "Posts"
FOR INSERT WITH CHECK (auth.role() = 'authenticated');
```

For tables without owner columns:
```sql
-- Generic authenticated access
CREATE POLICY "Users_authenticated_all" ON "Users"
FOR ALL USING (auth.role() = 'authenticated');
```

## Schema Names

Use custom PostgreSQL schema names:

```bash
erdus migrar-db --engine mysql --in ./input.sql --schema app --out ./output.sql
```

**Output:**
```sql
CREATE TABLE app."Users" (
  -- columns...
);

ALTER TABLE app."Posts" ADD CONSTRAINT "fk_Posts_user_id" 
FOREIGN KEY ("user_id") REFERENCES app."Users" ("id");
```

## Advanced Examples

### Complete SQL Server Migration

**Input File (`sqlserver-ecommerce.sql`):**
```sql
-- SQL Server E-commerce Schema
CREATE TABLE [dbo].[Customers] (
    [CustomerId] UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
    [Email] NVARCHAR(255) NOT NULL UNIQUE,
    [FirstName] NVARCHAR(100) NOT NULL,
    [LastName] NVARCHAR(100) NOT NULL,
    [CreatedAt] DATETIME2 DEFAULT GETDATE(),
    [IsActive] BIT DEFAULT 1
);

CREATE TABLE [dbo].[Orders] (
    [OrderId] UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
    [CustomerId] UNIQUEIDENTIFIER NOT NULL,
    [OrderDate] DATETIME2 DEFAULT GETDATE(),
    [Total] DECIMAL(10,2) NOT NULL DEFAULT 0.00,
    [Status] NVARCHAR(50) DEFAULT 'pending',
    CONSTRAINT [FK_Orders_Customers] FOREIGN KEY ([CustomerId]) 
        REFERENCES [dbo].[Customers]([CustomerId]) ON DELETE CASCADE
);

CREATE TABLE [dbo].[OrderItems] (
    [OrderItemId] UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
    [OrderId] UNIQUEIDENTIFIER NOT NULL,
    [ProductName] NVARCHAR(200) NOT NULL,
    [Quantity] INT NOT NULL DEFAULT 1,
    [Price] DECIMAL(10,2) NOT NULL,
    CONSTRAINT [FK_OrderItems_Orders] FOREIGN KEY ([OrderId])
        REFERENCES [dbo].[Orders]([OrderId]) ON DELETE CASCADE
);

-- Indexes
CREATE INDEX [IX_Orders_CustomerId] ON [dbo].[Orders]([CustomerId]);
CREATE INDEX [IX_Orders_OrderDate] ON [dbo].[Orders]([OrderDate]);
CREATE INDEX [IX_OrderItems_OrderId] ON [dbo].[OrderItems]([OrderId]);

-- Check Constraints
ALTER TABLE [dbo].[Orders] ADD CONSTRAINT [CK_Orders_Total] CHECK ([Total] >= 0);
ALTER TABLE [dbo].[OrderItems] ADD CONSTRAINT [CK_OrderItems_Quantity] CHECK ([Quantity] > 0);
```

**Migration Command:**
```bash
erdus migrar-db \
  --engine sqlserver \
  --in ./sqlserver-ecommerce.sql \
  --out ./supabase-ecommerce.sql \
  --with-rls \
  --schema ecommerce
```

**Generated Supabase Schema:**
```sql
-- Generated Supabase schema
-- Generated on: 2024-01-15T10:30:00.000Z

CREATE SCHEMA IF NOT EXISTS ecommerce;

-- Tables
CREATE TABLE ecommerce."Customers" (
  "CustomerId" uuid NOT NULL DEFAULT gen_random_uuid(),
  "Email" varchar(255) NOT NULL UNIQUE,
  "FirstName" varchar(100) NOT NULL,
  "LastName" varchar(100) NOT NULL,
  "CreatedAt" timestamp with time zone NOT NULL DEFAULT now(),
  "IsActive" boolean DEFAULT true,
  CONSTRAINT "Customers_pkey" PRIMARY KEY ("CustomerId")
);

CREATE TABLE ecommerce."Orders" (
  "OrderId" uuid NOT NULL DEFAULT gen_random_uuid(),
  "CustomerId" uuid NOT NULL,
  "OrderDate" timestamp with time zone NOT NULL DEFAULT now(),
  "Total" numeric(10,2) NOT NULL DEFAULT 0.00,
  "Status" varchar(50) DEFAULT 'pending',
  CONSTRAINT "Orders_pkey" PRIMARY KEY ("OrderId")
);

CREATE TABLE ecommerce."OrderItems" (
  "OrderItemId" uuid NOT NULL DEFAULT gen_random_uuid(),
  "OrderId" uuid NOT NULL,
  "ProductName" varchar(200) NOT NULL,
  "Quantity" integer NOT NULL DEFAULT 1,
  "Price" numeric(10,2) NOT NULL,
  CONSTRAINT "OrderItems_pkey" PRIMARY KEY ("OrderItemId")
);

-- Indexes
CREATE INDEX "IX_Orders_CustomerId" ON ecommerce."Orders" ("CustomerId");
CREATE INDEX "IX_Orders_OrderDate" ON ecommerce."Orders" ("OrderDate");
CREATE INDEX "IX_OrderItems_OrderId" ON ecommerce."OrderItems" ("OrderId");

-- Foreign Key Constraints
ALTER TABLE ecommerce."Orders" ADD CONSTRAINT "fk_Orders_CustomerId" 
FOREIGN KEY ("CustomerId") REFERENCES ecommerce."Customers" ("CustomerId") ON DELETE CASCADE;

ALTER TABLE ecommerce."OrderItems" ADD CONSTRAINT "fk_OrderItems_OrderId" 
FOREIGN KEY ("OrderId") REFERENCES ecommerce."Orders" ("OrderId") ON DELETE CASCADE;

-- Check Constraints
ALTER TABLE ecommerce."Orders" ADD CONSTRAINT "CK_Orders_Total" CHECK ("Total" >= 0);
ALTER TABLE ecommerce."OrderItems" ADD CONSTRAINT "CK_OrderItems_Quantity" CHECK ("Quantity" > 0);

-- Row Level Security
ALTER TABLE ecommerce."Customers" ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Customers_authenticated_all" ON ecommerce."Customers" 
FOR ALL USING (auth.role() = 'authenticated');

ALTER TABLE ecommerce."Orders" ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Orders_owner_select" ON ecommerce."Orders" 
FOR SELECT USING (auth.uid()::text = "CustomerId"::text);

ALTER TABLE ecommerce."OrderItems" ENABLE ROW LEVEL SECURITY;
CREATE POLICY "OrderItems_authenticated_all" ON ecommerce."OrderItems" 
FOR ALL USING (auth.role() = 'authenticated');
```

## Limitations

### Current Version Limitations

1. **DDL Only**: Currently supports only DDL (structure) migration, not data (DML)
2. **Stored Procedures**: Not supported in initial version
3. **Complex Views**: Basic view support only
4. **Custom Types**: Limited support for user-defined types
5. **Triggers**: Not migrated (would need manual conversion)

### Parser Limitations

- **SQL Server**: Handles basic CREATE TABLE, constraints, and indexes
- **MySQL**: Supports standard syntax, limited custom MySQL extensions
- **Oracle**: Basic support, complex Oracle-specific features need manual review
- **MongoDB**: Schema inference from JSON schema or sample documents
- **SQLite**: Type affinity conversion, some pragma settings ignored

## Best Practices

1. **Review Generated SQL**: Always review the generated PostgreSQL before applying
2. **Test Migration**: Use a development database first
3. **Backup**: Always backup your data before applying migrations
4. **Iterative Approach**: Migrate and test in smaller chunks for complex schemas
5. **Manual Verification**: Some complex constructs may need manual adjustment

## Troubleshooting

### Common Issues

**Issue**: `Unsupported database engine`
```bash
Error: Unsupported database engine: mssql
```
**Solution**: Use `sqlserver` instead of `mssql` for SQL Server

**Issue**: `Invalid JSON input`
```bash
Error: Invalid JSON input: Unexpected token
```
**Solution**: Ensure input file is valid SQL or JSON for MongoDB schemas

**Issue**: `No CREATE TABLE statements found`
```bash
Warning: No tables detected in input
```
**Solution**: Verify the input SQL contains CREATE TABLE statements

### Getting Help

For complex migrations or unsupported features:

1. Check the `mapping-tipos.md` documentation for supported type mappings
2. File an issue with sample SQL that isn't working
3. Consider breaking complex schemas into smaller parts
4. Use the `--out stdout` option to preview output without writing files

## Type Mapping Reference

See `mapping-tipos.md` for the complete type mapping reference between all supported database engines.